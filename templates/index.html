<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Monitor</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; height: 100vh; background-color: #f5f5f5; color: #333; }
    .sidebar { width: 280px; background: linear-gradient(135deg, #2c3e50, #1a2530); color: white; padding: 20px; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
    .sidebar-header { padding-bottom: 20px; border-bottom: 1px solid #34495e; margin-bottom: 20px; }
    .sidebar-header h1 { font-size: 1.5rem; margin-bottom: 10px; font-weight: 600; }
    .sidebar-header h2 { font-size: 1rem; font-weight: 400; color: #bdc3c7; margin-bottom: 10px; }

    .process-name .toggle {
      display: inline-block;
      width: 16px;
      text-align: center;
      margin-right: 5px;
      font-weight: bold;
      color: #2980b9;
    }
    .process-name .toggle:hover {
      cursor: pointer;
      color: #e74c3c;
    }

    
    /* üîΩ Host dropdown */
    .host-select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: none;
      background: #34495e;
      color: white;
      font-size: 0.95rem;
      outline: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    .host-select:hover { background: #3d566e; }

    .nav-buttons { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .nav-btn { padding: 12px 15px; background: #3498db; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; text-align: left; display: flex; align-items: center; gap: 10px; }
    .nav-btn:hover { background: #2980b9; transform: translateX(5px); }
    .nav-btn.active { background: #e74c3c; box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3); }
    .refresh-btn { padding: 12px 15px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; margin-top: auto; display: flex; align-items: center; justify-content: center; gap: 10px; background: #27ae60; color: white; }
    .refresh-btn:hover { background: #219653; transform: translateY(-2px); }
    .status { margin: 20px 0; padding: 12px; border-radius: 6px; font-size: 0.9rem; display: none; }
    .status.success { background: #d4edda; color: #155724; display: block; }
    .status.error { background: #f8d7da; color: #721c24; display: block; }
    .status.info { background: #d1ecf1; color: #0c5460; display: block; }
    .content { flex-grow: 1; padding: 30px; overflow: auto; background-color: #f8f9fa; }
    .tab { animation: fadeIn 0.3s ease; }
    .hidden { display: none; }
    .tab-header { margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
    .tab-header h2 { font-size: 1.8rem; color: #2c3e50; font-weight: 600; }
    .last-updated { color: #7f8c8d; font-size: 0.9rem; }
    .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
    .search-box input { padding: 10px 15px; border: 1px solid #ddd; border-radius: 6px; width: 300px; font-size: 0.9rem; }
    .search-box button { padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background 0.3s; }
    .search-box button:hover { background: #2980b9; }
    table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border-radius: 10px; overflow: hidden; }
    th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #34495e; color: white; font-weight: 600; position: sticky; top: 0; }
    tr:hover { background-color: #f8f9fa; }
    .process-name { font-weight: 500; }
    .process-pid { color: #829192; font-family: monospace; }
    .memory-high, .cpu-high { color: #e74c3c; font-weight: 600; }
    .pagination { display: flex; justify-content: center; margin-top: 20px; gap: 10px; }
    .pagination button { padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .pagination button:disabled { background: #bdc3c7; cursor: not-allowed; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <h1>System Monitor</h1>
      <h2 id="hostname">Loading...</h2>

      <!-- üîΩ Host dropdown here -->
      <select id="host-select" class="host-select">
        <option>Loading hosts...</option>
      </select>
    </div>

    <div class="nav-buttons">
      <button id="btn-system" class="nav-btn active"><i>üìä</i> System Details</button>
      <button id="btn-process" class="nav-btn"><i>‚öôÔ∏è</i> Processes Details</button>
    </div>

    <button id="btn-refresh" class="refresh-btn"><i>üîÑ</i> Refresh Now</button>
    <div id="status" class="status"></div>
  </div>

  <div class="content">
    <!-- System Tab -->
    <div id="system" class="tab">
      <div class="tab-header">
        <h2>System Information</h2>
        <div class="last-updated" id="system-last-updated"></div>
      </div>
      <table id="system-info-table">
        <thead><tr><th>Property</th><th>Value</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Process Tab -->
    <div id="process" class="tab hidden">
      <div class="tab-header">
        <h2>Running Processes</h2>
        <div class="last-updated" id="process-last-updated"></div>
      </div>
      <div class="search-box">
        <input type="text" id="process-search" placeholder="Search by name, PID, or path...">
        <button onclick="filterProcesses()">Search</button>
        <button onclick="clearSearch()">Clear</button>
      </div>
      <table>
        <thead><tr><th>PID</th><th>Name</th><th>Memory (MB)</th><th>CPU (%)</th><th>PPID</th></tr></thead>
        <tbody id="process-table"></tbody>
      </table>
      <div class="pagination">
        <button id="prev-page" onclick="changePage(-1)">Previous</button>
        <span id="page-info">Page 1 of 1</span>
        <button id="next-page" onclick="changePage(1)">Next</button>
      </div>
    </div>
  </div>

  <script>

const API_BASE = window.location.origin + "/api";

let allProcesses = [], currentPage = 1, processesPerPage = 50;
let currentSystemInfo = null, refreshInterval = null;
const AUTO_REFRESH_INTERVAL = 5000;
let currentTab = "system";
let selectedHost = null;

let expandedPIDs = new Set(); // keeps track of expanded processes
let currentSearch = ""; // keeps track of current search

const statusEl = document.getElementById("status");
const hostSelectEl = document.getElementById("host-select");
const hostnameEl = document.getElementById("hostname");
const systemLastUpdatedEl = document.getElementById("system-last-updated");
const processLastUpdatedEl = document.getElementById("process-last-updated");
const processTableEl = document.getElementById("process-table");
const prevPageBtn = document.getElementById("prev-page");
const nextPageBtn = document.getElementById("next-page");
const pageInfoEl = document.getElementById("page-info");

function showTab(tabId) {
  currentTab = tabId;
  document.querySelectorAll(".tab").forEach(el => el.classList.add("hidden"));
  document.getElementById(tabId).classList.remove("hidden");
  document.querySelectorAll(".nav-btn").forEach(btn => btn.classList.remove("active"));
  document.querySelector(`#btn-${tabId}`).classList.add("active");
  loadData(); // Refresh only current tab
}

function showStatus(msg, type = "info") {
  statusEl.textContent = msg;
  statusEl.className = `status ${type}`;
  setTimeout(() => { statusEl.textContent = ""; statusEl.className = "status"; }, 4000);
}

function formatGB(b) { return (b / (1024*1024*1024)).toFixed(1); }
function formatMB(m) { return typeof m === "number" ? m.toFixed(2) : "0.00"; }
function formatDate(d) { if (!d) return "Unknown"; return new Date(d).toLocaleString(); }

async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}

function renderProcessTable(procs = allProcesses) {
  // Save current expanded state
  expandedPIDs.clear();
  document.querySelectorAll(".toggle").forEach(toggle => {
    if (toggle.textContent === "‚ñº") {
      const tr = toggle.closest("tr");
      expandedPIDs.add(tr.dataset.pid);
    }
  });

  // Filter processes if search is active
  let filtered = procs;
  if (currentSearch) {
    filtered = procs.filter(p =>
      p.name.toLowerCase().includes(currentSearch) ||
      p.pid.toString().includes(currentSearch) ||
      (p.path && p.path.toLowerCase().includes(currentSearch))
    );
  }

  // Build parent-child map
  const childrenMap = {};
  filtered.forEach(p => {
    if (!childrenMap[p.ppid]) childrenMap[p.ppid] = [];
    childrenMap[p.ppid].push(p);
  });

  const allPIDs = new Set(filtered.map(p => p.pid));
  const topProcesses = filtered.filter(p => !allPIDs.has(p.ppid));

  // Pagination
  const totalPages = Math.ceil(topProcesses.length / processesPerPage) || 1;
  prevPageBtn.disabled = currentPage <= 1;
  nextPageBtn.disabled = currentPage >= totalPages;
  pageInfoEl.textContent = `Page ${currentPage} of ${totalPages}`;

  const start = (currentPage - 1) * processesPerPage;
  const end = start + processesPerPage;
  const pageTopProcesses = topProcesses.slice(start, end);

  function buildRows(process, level = 0) {
    const indent = "&nbsp;".repeat(level * 4);
    const hasChildren = !!childrenMap[process.pid];
    const rowId = `row-${process.pid}`;
    let html = `<tr id="${rowId}" data-pid="${process.pid}" data-level="${level}" class="process-row">
      <td>${process.pid}</td>
      <td class="process-name">${indent}${hasChildren ? '<span class="toggle">‚ñ∂</span> ' : ''}${process.name}</td>
      <td class="${process.memory_mb > 100 ? 'memory-high' : ''}">${formatMB(process.memory_mb)}</td>
      <td class="${process.cpu_percent > 10 ? 'cpu-high' : ''}">${process.cpu_percent?.toFixed(1) || "0.0"}</td>
      <td>${process.ppid}</td>
    </tr>`;

    if (hasChildren) {
      childrenMap[process.pid].forEach(child => {
        html += buildRows(child, level + 1);
      });
    }
    return html;
  }

  // Build table
  let html = "";
  pageTopProcesses.forEach(p => html += buildRows(p));
  processTableEl.innerHTML = html;

  // Hide all children initially
  document.querySelectorAll(".process-row").forEach(tr => {
    const level = parseInt(tr.dataset.level);
    if (level > 0) tr.style.display = "none";
  });

  // Add toggle click
  document.querySelectorAll(".toggle").forEach(toggle => {
    toggle.onclick = (e) => {
      const tr = e.target.closest("tr");
      const pid = tr.dataset.pid;
      const level = parseInt(tr.dataset.level);
      const showing = e.target.textContent === "‚ñº";
      e.target.textContent = showing ? "‚ñ∂" : "‚ñº";

      let next = tr.nextElementSibling;
      while (next && parseInt(next.dataset.level) > level) {
        if (showing) {
          next.style.display = "none";
          const childToggle = next.querySelector(".toggle");
          if (childToggle) childToggle.textContent = "‚ñ∂";
        } else {
          if (parseInt(next.dataset.level) === level + 1) next.style.display = "";
        }
        next = next.nextElementSibling;
      }
    };
  });

  // Restore expanded state
  document.querySelectorAll(".toggle").forEach(toggle => {
    const tr = toggle.closest("tr");
    if (expandedPIDs.has(tr.dataset.pid)) toggle.click();
  });
}

function changePage(delta) {
  currentPage += delta;
  renderProcessTable();
}

function filterProcesses() {
  currentSearch = document.getElementById("process-search").value.toLowerCase();
  currentPage = 1;
  renderProcessTable();
}

function clearSearch() {
  document.getElementById("process-search").value = "";
  currentSearch = "";
  currentPage = 1;
  renderProcessTable();
}

async function loadHosts() {
  try {
    const systems = await fetchJSON(`${API_BASE}/system-info-list/`);
    if (!systems.length) {
      hostSelectEl.innerHTML = `<option>No hosts found</option>`;
      return;
    }
    const hostnames = [...new Set(systems.map(s => s.hostname))];
    hostSelectEl.innerHTML = hostnames.map(h => `<option value="${h}">${h}</option>`).join("");
    if (!selectedHost) selectedHost = hostnames[0];
    hostSelectEl.value = selectedHost;
    loadData();
  } catch (e) {
    console.error(e);
    showStatus("Failed to load hosts", "error");
  }
}

async function loadData() {
  if (!selectedHost) return;

  try {
    if (currentTab === "system") {
      const systemInfo = await fetchJSON(`${API_BASE}/system-info/${selectedHost}/`);
      currentSystemInfo = systemInfo;
      hostnameEl.textContent = selectedHost;
      systemLastUpdatedEl.textContent = `Last updated: ${formatDate(systemInfo.collected_at)}`;

      document.querySelector("#system-info-table tbody").innerHTML = `
        <tr><td>Hostname</td><td>${systemInfo.hostname}</td></tr>
        <tr><td>Operating System</td><td>${systemInfo.os} ${systemInfo.release} (${systemInfo.os_version})</td></tr>
        <tr><td>Processor</td><td>${systemInfo.processor}</td></tr>
        <tr><td>Physical Cores</td><td>${systemInfo.physical_cores}</td></tr>
        <tr><td>Logical Cores</td><td>${systemInfo.logical_cores}</td></tr>
        <tr><td>CPU Frequency</td><td>${systemInfo.cpu_freq_current} MHz</td></tr>
        <tr><td>Total RAM</td><td>${formatGB(systemInfo.total_ram)} GB</td></tr>
        <tr><td>Used RAM</td><td>${formatGB(systemInfo.used_ram)} GB</td></tr>
        <tr><td>Available RAM</td><td>${formatGB(systemInfo.available_ram)} GB</td></tr>
        <tr><td>Storage Total</td><td>${formatGB(systemInfo.storage_total)} GB</td></tr>
        <tr><td>Storage Used</td><td>${formatGB(systemInfo.storage_used)} GB</td></tr>
        <tr><td>Storage Free</td><td>${formatGB(systemInfo.storage_free)} GB</td></tr>
        <tr><td>CPU Usage</td><td>${systemInfo.cpu_percent?.toFixed(1) || "0.0"}%</td></tr>
        <tr><td>Boot Time</td><td>${formatDate(new Date(systemInfo.boot_time*1000))}</td></tr>`;
    } else if (currentTab === "process") {
      const procs = await fetchJSON(`${API_BASE}/processes/?hostname=${selectedHost}`);
      allProcesses = procs.filter((p, index, arr) => 
      index === arr.findIndex(x => x.pid === p.pid)
    );
      processLastUpdatedEl.textContent = `Last updated: ${formatDate(allProcesses[0]?.sample_time * 1000) || "Unknown"}`;

      renderProcessTable();
    }
  } catch (e) {
    console.error(e);
    showStatus("Error loading data", "error");
  }
}

function startAutoRefresh() {
  if (refreshInterval) clearInterval(refreshInterval);
  refreshInterval = setInterval(loadData, AUTO_REFRESH_INTERVAL);
}

// Event Listeners
document.getElementById("btn-system").onclick = () => showTab("system");
document.getElementById("btn-process").onclick = () => showTab("process");
document.getElementById("btn-refresh").onclick = async () => {
  if (refreshInterval) clearInterval(refreshInterval);
  await loadData();
  startAutoRefresh();
};
hostSelectEl.onchange = (e) => { selectedHost = e.target.value; loadData(); };

window.onload = () => {
  showTab("system");
  loadHosts();
  startAutoRefresh();
};

  </script>
</body>
</html>
